#!/bin/bash
set -e

CONFIG="/usr/local/etc/xray/config.json"
CLIENTS_DIR="clients"
ENV_FILE=".env"
FLOW="xtls-rprx-vision"


usage() {
  cat <<EOF
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  vless add <client_name>
  vless enable <client_name>
  vless disable <client_name>
  vless remove <client_name>
  vless list
  ----------------------------------------
  vless init #—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ xray –Ω–∞ vless !!!! –û–°–¢–û–†–û–ñ–ù–û –≤–Ω–∏–º–∞–Ω–∏–µ —Å–Ω–æ—Å–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  vless status 
  vless stop
  vless start
EOF
  exit 1
}

# --- –ø—Ä–æ–≤–µ—Ä–∫–∏ ---
[ -f "$CONFIG" ] || { echo "‚ùå –ù–µ—Ç $CONFIG"; 
echo "–∑–∞–ø—É—Å—Ç–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å ./scripts/init_xray_server.sh"
exit 1; }
[ -f "$ENV_FILE" ] || { echo "‚ùå –ù–µ—Ç .env"; exit 1; }

mkdir -p "$CLIENTS_DIR"
source "$ENV_FILE"

extract_uuid() {
  local file="$1"
  sed -n 's|^vless://\([^@]*\)@.*|\1|p' "$file"
}

restart_xray() {
  systemctl restart xray
}

choose_random_shortid() {
  IFS=',' read -ra IDS <<< "$REALITY_SHORT_IDS"
  COUNT=${#IDS[@]}
  [ "$COUNT" -gt 0 ] || { echo "‚ùå REALITY_SHORT_IDS –ø—É—Å—Ç"; exit 1; }
  IDX=$((RANDOM % COUNT))
  echo "${IDS[$IDX]}"
}

CMD="$1"
NAME="$2"

case "$CMD" in

status)
echo "service xray"
service xray status 
echo "service iptables"
service iptables status
;;

stop)
echo "service xray"
service xray stop 
;;
restart)
echo "service xray"
service xray restart
echo "service iptables"
service iptables restart
;;

init)
./script/init_xray_server.sh
;;


add)
  [ -z "$NAME" ] && usage

  REALITY_SHORT_ID="$(choose_random_shortid)"
  UUID="$(xray uuid)"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è email
  if jq -e --arg email "$NAME" '.inbounds[].settings.clients[]? | select(.email == $email)' "$CONFIG" >/dev/null; then
    echo "‚ùå –ö–ª–∏–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º '$NAME' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
  fi

  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  jq --arg uuid "$UUID" --arg flow "$FLOW" --arg email "$NAME" \
     '.inbounds[0].settings.clients += [{"id": $uuid, "flow": $flow, "email": $email}]' \
     "$CONFIG" > /tmp/xray.json && mv /tmp/xray.json "$CONFIG"

  # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ Reality
  LINK="vless://${UUID}@${SERVER_IPV4}:${SERVER_PORT}?type=tcp&security=reality&flow=${FLOW}&sni=${SNI}&fp=chrome&pbk=${REALITY_PUBLIC_KEY}&sid=${REALITY_SHORT_ID}&alpn=h2,http/1.1#${NAME}"

  CLIENT_FILE="${CLIENTS_DIR}/${NAME}.txt"
  {
    echo "$LINK"
    echo
    qrencode -t ANSIUTF8 "$LINK"
  } > "$CLIENT_FILE"
  chmod 600 "$CLIENT_FILE"

  restart_xray

  echo "‚úÖ –ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω: $NAME"
  echo "UUID: $UUID"
  echo "Short ID: $REALITY_SHORT_ID"
  echo "–§–∞–π–ª: $CLIENT_FILE"
  ;;

disable)
  [ -z "$NAME" ] && usage

  FILE="$CLIENTS_DIR/$NAME.txt"
  [ -f "$FILE" ] || { echo "‚ùå –ù–µ—Ç $FILE"; exit 1; }

  UUID="$(extract_uuid "$FILE")"

  jq '.inbounds[].settings |= (if has("disabled_clients") then . else . + { "disabled_clients": [] } end)' \
     "$CONFIG" > /tmp/xray.json && mv /tmp/xray.json "$CONFIG"

  jq --arg uuid "$UUID" \
     '.inbounds[].settings |= (.disabled_clients += [ .clients[] | select(.id == $uuid) ] | .clients |= map(select(.id != $uuid)))' \
     "$CONFIG" > /tmp/xray.json && mv /tmp/xray.json "$CONFIG"

  restart_xray
  echo "‚è∏ –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á—ë–Ω: $NAME"
  ;;

enable)
  [ -z "$NAME" ] && usage

  FILE="$CLIENTS_DIR/$NAME.txt"
  [ -f "$FILE" ] || { echo "‚ùå –ù–µ—Ç $FILE"; exit 1; }

  UUID="$(extract_uuid "$FILE")"

  jq --arg uuid "$UUID" \
     '.inbounds[].settings |= (.clients += [ .disabled_clients[] | select(.id == $uuid) ] | .disabled_clients |= map(select(.id != $uuid)))' \
     "$CONFIG" > /tmp/xray.json && mv /tmp/xray.json "$CONFIG"

  restart_xray
  echo "‚ñ∂ –ö–ª–∏–µ–Ω—Ç –≤–∫–ª—é—á—ë–Ω: $NAME"
  ;;

remove)
  [ -z "$NAME" ] && usage

  FILE="$CLIENTS_DIR/$NAME.txt"
  [ -f "$FILE" ] || { echo "‚ùå –ù–µ—Ç $FILE"; exit 1; }

  UUID="$(extract_uuid "$FILE")"

  jq --arg uuid "$UUID" \
     '.inbounds[].settings |= (.clients |= map(select(.id != $uuid)) | .disabled_clients |= map(select(.id != $uuid)))' \
     "$CONFIG" > /tmp/xray.json && mv /tmp/xray.json "$CONFIG"

  rm -f "$FILE"
  restart_xray

  echo "üóë –ö–ª–∏–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω: $NAME"
  ;;

list)
  echo "üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã:"
  jq -r '.inbounds[].settings.clients[]?.email' "$CONFIG"

  echo
  echo "‚è∏ –û—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã:"
  jq -r '.inbounds[].settings.disabled_clients[]?.email' "$CONFIG"
  ;;






*)
  usage
  ;;
esac

